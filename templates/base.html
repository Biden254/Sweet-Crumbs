<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sweet Crumbs Bakery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
    </style>
</head>
<body class="bg-pink-50 text-slate-800">
    <nav class="bg-white/80 backdrop-blur sticky top-0 z-40 shadow">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <a href="/" class="text-2xl font-semibold text-pink-600">Sweet Crumbs</a>
            <div class="hidden md:flex gap-6 items-center">
                <a class="hover:text-pink-600" href="/">Home</a>
                <div class="relative" id="cat-menu">
                    <button class="hover:text-pink-600" id="cat-toggle">Categories</button>
                    <div class="absolute hidden bg-white rounded shadow p-3 mt-2 w-56" id="cat-dropdown">
                        <a class="block py-1 hover:text-pink-600" href="/shop?c=cupcakes">Cupcakes</a>
                        <a class="block py-1 hover:text-pink-600" href="/shop?c=cookies">Cookies</a>
                        <a class="block py-1 hover:text-pink-600" href="/shop?c=wedding">Wedding Cakes</a>
                        <a class="block py-1 hover:text-pink-600" href="/shop?c=birthday">Birthday Cakes</a>
                        <a class="block py-1 hover:text-pink-600" href="/shop?c=delivery">Cake Deliveries</a>
                        <a class="block py-1 hover:text-pink-600" href="/shop?c=decorating">Cake Decorating</a>
                    </div>
                </div>
                <a class="hover:text-pink-600" href="/shop/">Shop</a>
                <a class="hover:text-pink-600" href="/orders/cart/">Cart</a>
                <a class="hover:text-pink-600" href="/contact/">Contact</a>
                {% if request.user.is_authenticated %}
                <a class="hover:text-pink-600" href="/user/profile/">Profile</a>
                <a class="hover:text-pink-600" href="/accounts/logout/">Logout</a>
                {% else %}
                <a class="hover:text-pink-600" href="/accounts/login/">Login</a>
                <a class="hover:text-pink-600" href="/user/signup/">Sign up</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Chatbot Widget -->
    <div id="chatbot" class="fixed bottom-4 right-4">
        <button id="chat-toggle" aria-label="Open chat" class="w-12 h-12 rounded-full shadow-lg flex items-center justify-center bg-white border border-pink-200 hover:shadow-xl">
            <!-- Cupcake icon -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#db2777" class="w-7 h-7">
                <path d="M12 3a3 3 0 0 0-3 3c0 .34.06.67.17.97A3.5 3.5 0 0 0 5 10.5C5 12.43 6.57 14 8.5 14h7c1.93 0 3.5-1.57 3.5-3.5 0-1.6-1.09-2.95-2.56-3.36A3 3 0 0 0 12 3z"/>
                <path d="M7 15l1 6h8l1-6H7z"/>
            </svg>
        </button>
        <div id="chat-panel" class="hidden mt-2 w-80 bg-white rounded-lg shadow-xl overflow-hidden">
            <div class="bg-pink-600 text-white px-3 py-2">Bakery Assistant</div>
            <div id="chat-log" class="p-3 h-64 overflow-y-auto space-y-2 text-sm"></div>
            <form id="chat-form" class="flex border-t">
                <input id="chat-input" class="flex-1 p-2 outline-none" placeholder="Ask about orders, hours, delivery..." />
                <button class="px-3 text-pink-600">Send</button>
            </form>
        </div>
    </div>
    <script>
        // Hover-intent for Categories to prevent flicker
        (function(){
            const menu = document.getElementById('cat-menu');
            const dropdown = document.getElementById('cat-dropdown');
            if(menu && dropdown){
                let open = false;
                let enterTimer = null;
                let leaveTimer = null;
                const show = () => { dropdown.classList.remove('hidden'); open = true; };
                const hide = () => { dropdown.classList.add('hidden'); open = false; };
                menu.addEventListener('mouseenter', () => {
                    clearTimeout(leaveTimer);
                    enterTimer = setTimeout(show, 120); // small delay before opening
                });
                menu.addEventListener('mouseleave', () => {
                    clearTimeout(enterTimer);
                    leaveTimer = setTimeout(hide, 200); // delay before closing to allow moving cursor
                });
                // Also keep open when hovering dropdown itself
                dropdown.addEventListener('mouseenter', () => {
                    clearTimeout(leaveTimer);
                });
                dropdown.addEventListener('mouseleave', () => {
                    leaveTimer = setTimeout(hide, 200);
                });
            }
        })();

        const toggle = document.getElementById('chat-toggle');
        const panel = document.getElementById('chat-panel');
        const form = document.getElementById('chat-form');
        const input = document.getElementById('chat-input');
        const log = document.getElementById('chat-log');
        toggle.addEventListener('click', () => panel.classList.toggle('hidden'));
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const q = input.value.trim();
            if (!q) return;
            append('You', q);
            input.value = '';
            const { answer, handoff } = await askServer(q);
            append('Assistant', answer);
            if (handoff) renderHandoff(q);
        });
        function append(who, text){
            const div = document.createElement('div');
            div.innerHTML = `<div class='${who==='You'?'text-right':''}'><span class='inline-block px-3 py-2 rounded-lg ${who==='You'?'bg-pink-100':'bg-slate-100'}'>`+text+`</span></div>`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }
        async function askServer(message){
            try{
                const res = await fetch('/api/chat/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                if(!res.ok) throw new Error('bad response');
                return await res.json();
            } catch(err){
                // Fallback minimal client reply
                return { answer: 'Sorry, something went wrong. Please try again later.', handoff: true };
            }
        }

        function renderHandoff(lastQuestion){
            const div = document.createElement('div');
            div.className = 'p-3 border-t bg-slate-50 flex items-center gap-2';
            div.innerHTML = "<input id='contact-info' class='flex-1 border rounded px-2 py-1 text-sm' placeholder='Your email or phone (optional)'/>"+
                            "<button id='send-alert' class='px-3 py-1 text-sm rounded bg-pink-600 text-white'>Alert bakery</button>";
            panel.appendChild(div);
            const btn = div.querySelector('#send-alert');
            const contact = div.querySelector('#contact-info');
            btn.addEventListener('click', async () => {
                btn.disabled = true; btn.textContent = 'Sending...';
                try{
                    await fetch('/api/chat/alert/', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: lastQuestion, contact: contact.value })
                    });
                    btn.textContent = 'Sent';
                }catch(e){
                    btn.textContent = 'Failed';
                }
            });
        }
    </script>
</body>
</html>


